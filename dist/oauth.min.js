!function(){"use strict";function e(e,t){var n=_.intersection(_.keys(e),t);return n.length==t.length}function t(e,t,n,o){function r(o){return t.loadHost(),n({method:"post",url:t.composeAPIPath(d.token),headers:{"Content-type":"application/json","x-grant-type":"authorization_code","x-redirect-uri":t.redirectUri,"x-client-id":t.clientId,"x-scope":t.scope,"x-auth-code":o}}).then(function(t){return e.accessAllowed(t.data)},function(t){if(!t.data)return e.accessUnavailable("requestToken");var n=t.data,o=n.error+": "+n.errorDescription;return e.accessDenied(o)})}function a(o){return t.loadHost(),n({method:"post",url:t.composeAPIPath(d.token),headers:{"Content-type":"application/json","x-grant-type":"refresh_token","x-redirect-uri":t.redirectUri,"x-client-id":t.clientId,"x-scope":t.scope,"x-refresh-token":o}}).then(function(t){return e.accessAllowed(t.data)},function(t){if(!t.data)return e.accessUnavailable("refreshToken");var n=t.data,o=n.error+": "+n.errorDescription;return e.accessDenied(o)})}function i(o){return n({method:"get",url:t.composeAPIPath(d.tokenInfo),headers:{"x-token":o}}).then(function(){return e.accessAllowed()},function(t){if(!t.data)return e.accessUnavailable("verifyToken");var n=t.data,o=n.error+": "+n.errorDescription;return e.accessDenied(o)})}function s(e){return n({method:"get",url:t.composeAPIPath(d.revoke),headers:{"x-token":e}})}function u(){o.path("/")}function c(){if("oauth-dev"in window.localStorage){var t=window.localStorage["oauth-dev"].split(","),n=t[2],o=t[3];return{"x-auth-username":n,"x-auth-password":o}}return{"x-access-token":e.getAccessToken()}}function l(e){return 401==e.status}var d={token:"/external/api/oauth2/token",revoke:"/external/api/oauth2/revoke",tokenInfo:"/external/api/oauth2/tokeninfo"};return{requestToken:r,refreshToken:a,verifyToken:i,logout:s,onAccessDenied:u,getAccessHeaders:c,badCredentials:l}}function n(e,t){function n(n){var o,r=t.get("$http"),a=t.get("OAuth"),i=t.get("oaLog"),s=e.defer();return a.badCredentials(n)?(i.debug("OAuth::Recovery","Request failed due to bad credentials..."),o="access_denied: The server does not recognize the credentials.",a.onAccessDenied(o),n.status=0,e.reject(n)):a.mayRefresh(n)?a.getRefreshToken()?(i.debug("OAuth::Recovery","Request failed but we may be able to recover..."),a.refreshToken().then(s.resolve,s.reject),s.promise.then(function(){return a.setAccessHeaders(n.config.headers),r(n.config)})):(i.debug("OAuth::Recovery","Request failed while using the implicit grant, cannot recover..."),o="access_denied: Cannot obtain automatic access while using the implicit grant.",a.onAccessDenied(o),e.reject(n)):e.reject(n)}return{responseError:n}}function o(e,t,n,o,r,a){function i(e){if(P=e,"oauth-dev"in window.localStorage){var n=window.localStorage["oauth-dev"].split(","),o=n[0],r=n[1];t.storeHost({host:o,site:r,clientId:"dev",redirectUri:"dev",authorizePath:"dev"})}}function s(e){if(e.state=e.state||(new Date).valueOf(),null===t.storeHost(e))throw"OAuth.login did not receive the required parameters.";var i={loadSite:r.defer(),exitSite:r.defer(),loadToken:r.defer()},s=t.composeAuthPath({response_type:e.responseType||"code"}),u=t.redirectUri,c=0===document.location.href.indexOf("file://"),l=function(e){return 0===e.indexOf(t.site)},d=function(e){return 0===e.indexOf(u)},h=function(e,t){var r=n.parse(e);if(_.has(r,"code")){var a=r.code;delete r.code,o.debug("OAuth.login","code in query..."),A(a).then(function(){o.debug("OAuth.login","requestToken success."),t.resolve()},function(){o.debug("OAuth.login","requestToken error."),t.reject()})}else _.has(r,"access_token")?(o.debug("OAuth.login","access_token in query..."),console.error("Not done yet...")):(o.debug("OAuth.login","No known variables in query..."),t.reject());window.localStorage["oauth-query"]=JSON.stringify(r)},g=function(e,t,n,r){function a(n){if(d(n.url)){r.resolve(),e.close(),o.debug("OAuth.login:InAppBrowser","Got a query from host site.");var a=n.url.substring(u.length+1);h(a,t)}}function i(t){l(t.url)&&(o.debug("OAuth.login:InAppBrowser","Host site is done loading."),n.resolve("load_success"),e.removeEventListener("loadstop",i),e.show())}function s(a){d(a.url)||(o.debug("OAuth.login:InAppBrowser","Error loading: "+a.url),n.reject("load_error"),t.reject(),r.resolve(),f("login:loadError"),e.close())}function c(){e.removeEventListener("loadstart",a),e.removeEventListener("loadstop",i),e.removeEventListener("loaderror",s),e.removeEventListener("exit",c)}e.addEventListener("loadstart",a),e.addEventListener("loadstop",i),e.addEventListener("loaderror",s),e.addEventListener("exit",c)};return o.debug("OAuth.login","Checking for site availability..."),a({method:"GET",url:s}).then(function(){if(o.debug("OAuth.login","Site is active. Attempting login."),!c)throw"Desktop implementation not yet done.";var e=window.open(s,"_blank","location=no,hidden=yes,toolbarposition=top,closebuttoncaption=Cancel");g(e,i.loadToken,i.loadSite,i.exitSite)},function(e){o.debug("OAuth.login","Failed to load the host site."),i.loadSite.reject(e),i.loadToken.reject(),i.exitSite.reject()}),{loadSite:i.loadSite.promise,loadToken:i.loadToken.promise,exitSite:i.exitSite.promise}}function u(){return t.loadHost(),P[t.name]}function c(e,t){return S.hasOwnProperty(e)||(S[e]=null),null===S[e]?(o.debug("OAuth::submitRequest","Submitting a request -> "+e),S[e]=t(),S[e]["finally"](function(){S[e]=null})):o.warn("OAuth::submitRequest","Request already in progress -> "+e),S[e]}function l(){return"oauth-dev"in window.localStorage?!0:e.loadToken()?!0:!1}function d(t){return o.debug("OAuth","Access was denied => "+t),l()&&(0!==t.indexOf("access_denied")&&(o.debug("OAuth","The token may exist in the server, attempting to logout. "),b()),e.clearToken()),{status:!1,reason:t}}function h(t){return t?(e.storeToken(t),o.debug("OAuth",t.expires_in+" seconds of access with the token "+t.access_token)):o.debug("OAuth","Access was granted. No data was provided."),{status:!0,reason:"access granted"}}function f(e){return o.debug("OAuth","Access is unavailable -> "+e),"function"==typeof u().onAccessDenied&&u().onAccessDenied("host_offline",e),{status:!1,reason:"host_offline"}}function g(){if(o.debug("OAuth::hasAccess","hasAccess() has been called."),l())return o.debug("OAuth::hasAccess","Allowing access without verification."),r.when(h());var e=n.get();return e&&e.code?(o.debug("OAuth::hasAccess","Wait while a token is requested with the code: "+e.code+"."),A(e.code)):(o.debug("OAuth::hasAccess","There is no token, thus no access."),r.when(d("missing_token")))}function p(){return e.loadToken(),e.accessToken}function k(){return e.loadToken(),e.refreshToken}function v(){return t.loadHost()?t.site:""}function A(e){return c("OAuth.requestToken",function(){return u().requestToken(e)})}function w(){return c("OAuth.refreshToken",function(){return u().refreshToken(k())})}function m(){return c("OAuth.verifyToken",function(){return u().verifyToken(p())})}function b(){return c("OAuth.logout",function(){var t=p(),n=u();return e.clearToken(),n?n.logout(t):void 0})}function y(e){d(e),"function"==typeof u().onAccessDenied&&u().onAccessDenied(e)}function T(e){return angular.extend(e,u().getAccessHeaders())}function O(e){var t=u();return t.hasOwnProperty("badCredentials")?t.badCredentials(e):401==e.status}function x(e){var t=u();return t.hasOwnProperty("mayRefresh")?t.mayRefresh(e):403==e.status}var S={},P=null;return{init:i,login:s,submitRequest:c,hasToken:l,accessDenied:d,accessAllowed:h,accessUnavailable:f,hasAccess:g,getAccessToken:p,getRefreshToken:k,getHostSite:v,composeAPIPath:t.composeAPIPath,getHostService:u,requestToken:A,refreshToken:w,verifyToken:m,logout:b,onAccessDenied:y,setAccessHeaders:T,badCredentials:O,mayRefresh:x}}function r(e){function t(){return a(e.hash())}function n(t){return e.hash(i(t)),t}function o(){for(var e=t()||{},o=0,r=arguments.length;r>o;o++)delete e[arguments[o]];return n(e)}function r(){var e=Array.prototype.slice.call(arguments);return e.unshift(t()||{}),n(angular.extend.apply(this,e))}function a(e){for(var t,n={},o=!0,r=e.split("&"),a=0;a<r.length;a++)t=r[a].split("="),""!==t[0]&&(o=!1,n[t[0]]=decodeURIComponent(t[1]));return o?null:n}function i(e){return Object.keys(e).map(function(t){return t+"="+encodeURIComponent(e[t])}).join("&")}return{get:t,set:n,del:o,extend:r,parse:a,compose:i}}function a(t,n){function o(){return c||r()}function r(e){var t=null,o=!1;return e?t=u(e):"oauth-host"in window.localStorage&&(t=u(JSON.parse(window.localStorage["oauth-host"])),t&&(o=!0)),c=t,c?(o||(n.debug("oaHost::storeHost","Storing "+c.host+" host"),window.localStorage["oauth-host"]=JSON.stringify(c)),h.name=c.host,h.site=c.site,h.clientId=c.clientId,h.redirectUri=c.redirectUri,h.authorizedPath=c.authorizedPath,h.clientSecret=c.clientSecret,h.scope=c.scope,h.state=c.state):a(),c}function a(){h.name="",h.site="",h.clientId="",h.redirectUri="",h.authorizedPath="",h.clientSecret="",h.scope="",h.state="",delete window.localStorage["oauth-host"],c=null}function i(e){var t={client_id:c.clientId,redirect_uri:c.redirectUri,scope:c.scope,response_type:"code",state:c.state};return angular.extend(t,e),s(c.authorizePath,t)}function s(e,n){if(c){n=n||{};var o=-1!=c.authorizePath.indexOf("?"),r=o?"&":"?",a=t.compose(n),i=c.site+e;return a&&(i+=r+a),i}return null}function u(t){return e(t,l)?_.defaults(t,d):null}var c=null,l=["host","site","clientId","redirectUri","authorizePath"],d={clientSecret:"",scope:"",state:""},h={name:"",site:"",clientId:"",redirectUri:"",authorizedPath:"",clientSecret:"",scope:"",state:"",loadHost:o,storeHost:r,clearHost:a,composeAuthPath:i,composeAPIPath:s};return h}function i(e){function t(e){return function(t,n){i||s[t]||e("["+t+"]: "+n)}}function n(){i=!0}function o(){i=!1}function r(e){s[e]=!1}function a(e){s[e]=!0}var i=!0,s={};return{turnOff:n,turnOn:o,enableContext:r,disableContext:a,log:t(e.log),info:t(e.info),warn:t(e.warn),error:t(e.error),debug:t(e.debug)}}function s(t,n){function o(){return l||r()}function r(e){var t=u(),o=!1;if(null===t)if(e)t=s(e);else if("oauth-token"in window.localStorage){var r=JSON.parse(window.localStorage["oauth-token"]);t=s(r),t&&(o=!0)}return l=t,l?(o||(n.debug("oaToken::storeToken","Storing token "+l.access_token+" <-> "+l.expires_in+" sec"),window.localStorage["oauth-token"]=JSON.stringify(l)),f.accessToken=l.access_token,f.refreshToken=l.refresh_token):a(),l}function a(){f.accessToken="",f.refreshToken="",delete window.localStorage["oauth-token"],l=null}function i(){return null===l||l.expires_at<new Date}function s(t){if(!e(t,d))return null;var n=_.defaults(t,h);return c(n)}function u(){var e=t.get(),o=s(e);return o&&(n.debug("oaToken::extractHash","Token was found in url"),t.del.apply(this,d.concat(_.keys(h)))),o}function c(e){if(e.expires_at)e.expires_at=new Date(e.expires_at);else{var t=new Date,n=t.getSeconds()+parseInt(e.expires_in);t.setSeconds(n),e.expires_at=t}return e}var l=null,d=["token_type","access_token","expires_in"],h={expires_at:null,refresh_token:"",scope:"",state:""},f={accessToken:"",refreshToken:"",loadToken:o,storeToken:r,clearToken:a,isExpired:i};return f}angular.module("oauth",[]),angular.module("oauth").factory("oauthIOffice",["OAuth","oaHost","$http","$location",t]),angular.module("oauth").factory("oaRecovery",["$q","$injector",n]).config(["$httpProvider",function(e){e.interceptors.push("oaRecovery")}]),angular.module("oauth").factory("OAuth",["oaToken","oaHost","oaHash","oaLog","$q","$http",o]),angular.module("oauth").factory("oaHash",["$location",r]),angular.module("oauth").factory("oaHost",["oaHash","oaLog",a]),angular.module("oauth").factory("oaLog",["$log",i]),angular.module("oauth").factory("oaToken",["oaHash","oaLog",s])}();